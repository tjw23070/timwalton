<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal File Depository</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #36454F;
            color: #F3F4F6;
        }
        .hidden { display: none; }
        .btn {
            @apply py-2 px-4 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-75 transition duration-150 ease-in-out disabled:opacity-50;
        }
        .btn-danger {
            @apply bg-red-600 hover:bg-red-700 focus:ring-red-500;
        }
        .input-field {
            @apply mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-sm shadow-sm placeholder-gray-400 text-gray-50 focus:outline-none focus:border-sky-500 focus:ring-1 focus:ring-sky-500;
        }
        .file-item {
            @apply p-3 mb-2 bg-gray-700 rounded-md shadow flex justify-between items-center hover:bg-gray-600 transition-colors;
        }
        .file-item span {
            @apply truncate mr-2 text-gray-100;
        }
        #constructionExclamation {
            cursor: pointer;
            font-weight: bold;
        }
        .modal {
            @apply fixed inset-0 bg-black bg-opacity-75 overflow-y-auto h-full w-full flex items-center justify-center z-50;
        }
        .modal-content {
            @apply bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md text-gray-100;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #0EA5E9;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #confirmationModal .modal-content {
            @apply max-w-sm;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <div id="appContainer" class="w-full max-w-2xl bg-gray-800 p-8 rounded-xl shadow-2xl">
        <div id="constructionMessage" class="text-center">
            <h1 class="text-3xl font-bold text-gray-100">
                Site Under Construction<span id="constructionExclamation" title="Login">!</span>
            </h1>
        </div>

        <div id="loginModal" class="modal hidden">
            <div class="modal-content">
                <h2 class="text-2xl font-semibold mb-6 text-center text-gray-100">Login</h2>
                <form id="loginForm">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="username" name="username" class="input-field" required value="admin">
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="password" name="password" class="input-field" required value="password123">
                    </div>
                    <button type="submit" class="btn w-full">Login</button>
                    <p id="loginError" class="text-red-400 text-sm mt-2 text-center"></p>
                    <button type="button" id="closeLoginModal" class="mt-4 w-full py-2 px-4 bg-gray-600 text-gray-200 font-semibold rounded-lg hover:bg-gray-500 transition duration-150 ease-in-out">Cancel</button>
                </form>
            </div>
        </div>

        <div id="fileManagementSection" class="hidden mt-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-100">File Depository</h2>
                <button id="logoutButton" class="btn btn-danger">Logout</button>
            </div>
            <div id="userInfo" class="mb-4 p-3 bg-gray-700 rounded-md text-sky-300 text-sm">
                Logged in as: <span id="loggedInUser" class="font-semibold">admin</span><br> User ID: <span id="currentUserId" class="font-mono text-xs break-all text-sky-400"></span>
            </div>
            <div class="mb-8 p-6 bg-gray-700 rounded-lg shadow">
                <h3 class="text-xl font-medium mb-4 text-gray-200">Upload New File</h3>
                <input type="file" id="fileInput" class="block w-full text-sm text-gray-400
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-sky-800 file:text-sky-200
                    hover:file:bg-sky-700 mb-2
                "/>
                <button id="uploadButton" class="btn mt-2 w-full sm:w-auto">Upload File</button>
                <p id="uploadStatus" class="text-sm mt-2 text-gray-300"></p>
                <div id="uploadLoading" class="loading-spinner hidden mx-auto mt-2"></div>
            </div>
            <div>
                <h3 class="text-xl font-medium mb-4 text-gray-200">Uploaded Files</h3>
                <div id="fileList" class="space-y-3">
                    <p id="noFilesMessage" class="text-gray-400">No files uploaded yet.</p>
                </div>
                <div id="filesLoading" class="loading-spinner hidden mx-auto mt-4"></div>
            </div>
        </div>
    </div>

    <div id="confirmationModal" class="modal hidden">
        <div class="modal-content">
            <h3 id="confirmationTitle" class="text-lg font-semibold mb-4 text-gray-100">Confirm Action</h3>
            <p id="confirmationMessage" class="mb-6 text-sm text-gray-300">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirmCancelButton" class="btn bg-gray-600 hover:bg-gray-500 text-gray-200">Cancel</button>
                <button id="confirmActionButton" class="btn btn-danger">Confirm</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            collection,
            addDoc,
            doc,
            onSnapshot,
            query,
            deleteDoc,
            Timestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import {
            getStorage,
            ref,
            uploadBytesResumable,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAP7ZnZqLgRV3XhJsMg1vl6e0wnu6WaZVg",
          authDomain: "files-52391.firebaseapp.com",
          projectId: "files-52391",
          storageBucket: "files-52391.firebasestorage.app", // Using your provided value
          messagingSenderId: "14939471052",
          appId: "1:14939471052:web:fdcc08e1994b5fd314d669",
          measurementId: "G-Y94SYPHL5V"
        };

        const hostAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-file-depository-app';

        let app;
        let auth;
        let db;
        let storage;
        let analytics;
        let currentUserId = null;
        let unsubscribeFiles = null;
        let isAuthReady = false; // Tracks if initial authentication attempts have completed

        // DOM Elements
        const appContainer = document.getElementById('appContainer');
        const constructionMessageEl = document.getElementById('constructionMessage');
        const constructionExclamationEl = document.getElementById('constructionExclamation');
        const loginModalEl = document.getElementById('loginModal');
        const loginFormEl = document.getElementById('loginForm');
        const closeLoginModalBtn = document.getElementById('closeLoginModal');
        const loginErrorEl = document.getElementById('loginError');
        const fileManagementSectionEl = document.getElementById('fileManagementSection');
        const logoutButtonEl = document.getElementById('logoutButton');
        const loggedInUserEl = document.getElementById('loggedInUser');
        const currentUserIdEl = document.getElementById('currentUserId');
        const fileInputEl = document.getElementById('fileInput');
        const uploadButtonEl = document.getElementById('uploadButton');
        const uploadStatusEl = document.getElementById('uploadStatus');
        const uploadLoadingEl = document.getElementById('uploadLoading');
        const fileListEl = document.getElementById('fileList');
        const noFilesMessageEl = document.getElementById('noFilesMessage');
        const filesLoadingEl = document.getElementById('filesLoading');
        const confirmationModalEl = document.getElementById('confirmationModal');
        const confirmationTitleEl = document.getElementById('confirmationTitle');
        const confirmationMessageEl = document.getElementById('confirmationMessage');
        const confirmCancelButtonEl = document.getElementById('confirmCancelButton');
        const confirmActionButtonEl = document.getElementById('confirmActionButton');
        let confirmActionCallback = null;


        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            analytics = getAnalytics(app);
            setLogLevel('debug'); // 'debug' for verbose logging, 'silent' to turn off
            console.log("Firebase SDKs initialized successfully for project ID:", firebaseConfig.projectId);
        } catch (error) {
            console.error("FATAL: Error initializing Firebase SDKs:", error);
            if (appContainer) {
                appContainer.innerHTML = `<div class="text-red-400 text-center p-4"><h2 class="text-xl font-bold text-red-300">Firebase Initialization Error</h2><p>Could not initialize Firebase services. Please check your `+"`firebaseConfig`"+` and ensure Firebase SDKs are loaded correctly.</p><p class="text-sm mt-2">${error.message}</p></div>`;
            }
            // If Firebase doesn't initialize, auth will never be ready.
            isAuthReady = true; // Set to true to prevent UI hangs, though app won't be functional.
        }


        function showConstructionMessage() {
            constructionMessageEl.classList.remove('hidden');
            loginModalEl.classList.add('hidden');
            fileManagementSectionEl.classList.add('hidden');
            if (unsubscribeFiles) {
                unsubscribeFiles();
                unsubscribeFiles = null;
            }
        }

        function showLoginModal() {
            loginModalEl.classList.remove('hidden');
            loginErrorEl.textContent = '';
        }

        function showFileManagement() {
            if (!currentUserId) {
                console.warn("Attempted to showFileManagement without currentUserId.");
                sessionStorage.removeItem('isUserLoggedInViaForm');
                showConstructionMessage();
                return;
            }
            constructionMessageEl.classList.add('hidden');
            loginModalEl.classList.add('hidden');
            fileManagementSectionEl.classList.remove('hidden');
            currentUserIdEl.textContent = currentUserId;
            loggedInUserEl.textContent = loginFormEl.username.value || "admin";
            fetchAndDisplayFiles();
        }

        function openConfirmationModal(title, message, onConfirm) {
            confirmationTitleEl.textContent = title;
            confirmationMessageEl.textContent = message;
            confirmActionCallback = onConfirm;
            confirmationModalEl.classList.remove('hidden');
        }

        function closeConfirmationModal() {
            confirmationModalEl.classList.add('hidden');
            confirmActionCallback = null;
        }

        confirmCancelButtonEl.addEventListener('click', closeConfirmationModal);
        confirmActionButtonEl.addEventListener('click', () => {
            if (confirmActionCallback) confirmActionCallback();
            closeConfirmationModal();
        });

        async function initializeAuth() {
            if (!auth) {
                console.error("Firebase Auth service is not available. Cannot proceed with authentication.");
                isAuthReady = true; // Mark as ready to prevent indefinite waiting
                showConstructionMessage(); // Show a safe default state
                 if (appContainer && !appContainer.innerHTML.includes("Firebase Initialization Error") && !appContainer.innerHTML.includes("Critical Error")) {
                     appContainer.innerHTML = `<div class="text-red-400 text-center p-4"><h2 class="text-xl font-bold text-red-300">Authentication Service Error</h2><p>The authentication service could not be initialized. Please refresh the page.</p></div>`;
                }
                return;
            }

            console.log("initializeAuth: Starting authentication process for project:", firebaseConfig.projectId);
            let attemptAnonymousSignIn = true; // Assume we need to try anonymous unless custom token works

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    console.log("Attempting to sign in with custom token (__initial_auth_token found).");
                    await signInWithCustomToken(auth, __initial_auth_token);
                    if (auth.currentUser) {
                        console.log("Successfully signed in with custom token. UID:", auth.currentUser.uid);
                        attemptAnonymousSignIn = false; // No need for anonymous if custom token worked
                    } else {
                         console.warn("signInWithCustomToken call completed, but auth.currentUser is still null. This is unexpected.");
                         // Proceed to anonymous sign-in attempt
                    }
                } catch (customTokenError) {
                    console.warn(`signInWithCustomToken failed: ${customTokenError.code} - ${customTokenError.message}. Will attempt anonymous sign-in.`);
                    // Fall through to attemptAnonymousSignIn = true
                }
            } else {
                console.log("No __initial_auth_token found. Will proceed based on current auth state or attempt anonymous sign-in.");
            }

            // If not signed in via custom token and no user is currently authenticated (e.g., from a previous session)
            if (attemptAnonymousSignIn && !auth.currentUser) {
                try {
                    console.log("Attempting anonymous sign-in for project:", firebaseConfig.projectId);
                    await signInAnonymously(auth);
                    if (auth.currentUser) {
                        console.log("Anonymous sign-in successful. UID:", auth.currentUser.uid);
                    } else {
                        console.warn("signInAnonymously call completed, but auth.currentUser is still null.");
                        // This state might indicate a deeper issue with Firebase setup or transient error.
                    }
                } catch (anonError) {
                    console.error(`Anonymous sign-in failed: ${anonError.code} - ${anonError.message}`);
                    if (appContainer && !appContainer.innerHTML.includes("Firebase Initialization Error") && !appContainer.innerHTML.includes("Critical Error")) {
                        appContainer.innerHTML = `<div class="text-red-400 text-center p-4">
                            <h2 class="text-xl font-bold text-red-300">Authentication Error</h2>
                            <p>Could not sign in anonymously. Please check:</p>
                            <ul class="list-disc list-inside text-left max-w-md mx-auto mt-2">
                                <li>Your internet connection.</li>
                                <li>That "Anonymous" sign-in is enabled in your Firebase project console for project ID: ${firebaseConfig.projectId}.</li>
                            </ul>
                            <p class="text-sm mt-2">Error details: ${anonError.code}</p>
                        </div>`;
                    }
                }
            } else if (auth.currentUser) {
                // This means user was already signed in (e.g. from custom token, or previous session restored by Firebase)
                console.log("User already authenticated prior to or during initializeAuth. UID:", auth.currentUser.uid);
            }

            isAuthReady = true;
            console.log("initializeAuth: Process finished. isAuthReady:", isAuthReady, "Current Firebase user:", auth.currentUser ? auth.currentUser.uid : "null");
            // onAuthStateChanged will ultimately determine the UI based on the final auth state.
        }


        if (auth) { // Only set up onAuthStateChanged if auth was initialized
            onAuthStateChanged(auth, (user) => {
                console.log("onAuthStateChanged triggered. User:", user ? user.uid : "null", ". Previously, isAuthReady was:", isAuthReady);
                isAuthReady = true; // Definitely ready after the first onAuthStateChanged callback
                if (user) {
                    currentUserId = user.uid;
                    console.log("onAuthStateChanged: User is signed in with UID:", currentUserId);
                    if (sessionStorage.getItem('isUserLoggedInViaForm') === 'true') {
                         if (fileManagementSectionEl.classList.contains('hidden')) {
                            showFileManagement();
                        }
                    } else {
                        // User is Firebase authenticated but not "form logged in"
                        // Ensure construction message is shown if file management isn't already.
                        if (!fileManagementSectionEl.classList.contains('hidden')) {
                           showConstructionMessage(); // If somehow file management was shown, revert
                        } else {
                           // Construction message should already be visible or will be handled by initial DOMContentLoaded
                        }
                    }
                } else {
                    currentUserId = null;
                    console.log("onAuthStateChanged: User is signed out.");
                    sessionStorage.removeItem('isUserLoggedInViaForm');
                    showConstructionMessage();
                }
            });
        }


        document.addEventListener('DOMContentLoaded', () => {
            if (auth && db && storage) { // Check if Firebase services were successfully initialized
                 initializeAuth(); // Start the authentication process
            } else {
                console.error("Firebase services (auth, db, storage) were not properly initialized before DOMContentLoaded. Auth will not proceed.");
                isAuthReady = true; // Mark as "ready" to avoid blocking UI, though auth will be broken
                showConstructionMessage(); // Show a default safe state
                if (appContainer && !appContainer.innerHTML.includes("Firebase Initialization Error")) {
                     appContainer.innerHTML = `<div class="text-red-400 text-center p-4"><h2 class="text-xl font-bold text-red-300">Critical Error</h2><p>Core application components failed to load. Please refresh.</p></div>`;
                }
            }
        });

        constructionExclamationEl.addEventListener('click', () => {
            console.log("Exclamation clicked. isAuthReady:", isAuthReady, "currentUserId:", currentUserId);
            if (!isAuthReady) {
                // This case should ideally be rare if DOMContentLoaded waits for basic init.
                alert("Application is still initializing. Please wait a moment and try again.");
                console.warn("Clicked '!' before auth initialization sequence completed (isAuthReady is false).");
                return;
            }

            if (currentUserId) { // User is authenticated with Firebase (e.g., anonymously)
                showLoginModal();
            } else {
                // This means isAuthReady is true, but currentUserId is null, indicating all auth attempts failed.
                console.error("Cannot open login: No authenticated Firebase user. Anonymous sign-in might have failed or is still in progress without success.");
                alert("Authentication is required to log in. Anonymous sign-in failed. Please check your internet connection and ensure Anonymous sign-in is enabled for this site in Firebase. Refresh the page and check the console for errors.");
            }
        });

        closeLoginModalBtn.addEventListener('click', () => {
            loginModalEl.classList.add('hidden');
        });

        loginFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = loginFormEl.username.value;
            const password = loginFormEl.password.value;

            if (username === 'admin' && password === 'password123') {
                if (!currentUserId) {
                    loginErrorEl.textContent = 'Error: Not authenticated with the server. Please refresh the page.';
                    console.error("Login form submitted but no currentUserId. Firebase auth issue.");
                    return;
                }
                loginErrorEl.textContent = '';
                sessionStorage.setItem('isUserLoggedInViaForm', 'true');
                showFileManagement();
            } else {
                loginErrorEl.textContent = 'Invalid username or password.';
            }
        });

        logoutButtonEl.addEventListener('click', async () => {
            sessionStorage.removeItem('isUserLoggedInViaForm');
            showConstructionMessage();
        });

        uploadButtonEl.addEventListener('click', async () => {
            if (!db || !storage || !currentUserId) {
                uploadStatusEl.textContent = 'Error: Services not ready or user not logged in.';
                uploadStatusEl.className = 'text-sm mt-2 text-red-400';
                return;
            }
             if (!isAuthReady) { // Should generally be true by now if currentUserId is set
                 uploadStatusEl.textContent = 'Authentication is initializing. Please wait.';
                 uploadStatusEl.className = 'text-sm mt-2 text-yellow-400';
                 return;
            }

            const file = fileInputEl.files[0];
            if (!file) {
                uploadStatusEl.textContent = 'Please select a file to upload.';
                uploadStatusEl.className = 'text-sm mt-2 text-red-400';
                return;
            }

            uploadStatusEl.textContent = `Uploading ${file.name}... (0%)`;
            uploadStatusEl.className = 'text-sm mt-2 text-sky-400';
            uploadButtonEl.disabled = true;
            fileInputEl.disabled = true;
            uploadLoadingEl.classList.remove('hidden');

            const storagePath = `artifacts/${hostAppId}/users/${currentUserId}/files/${Date.now()}_${file.name}`;
            const fileStorageRef = ref(storage, storagePath);

            try {
                const uploadTask = uploadBytesResumable(fileStorageRef, file);
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        uploadStatusEl.textContent = `Uploading ${file.name}... (${Math.round(progress)}%)`;
                    },
                    (error) => {
                        console.error("Upload failed:", error.code, error.message, error);
                        uploadStatusEl.textContent = `Upload failed: ${error.code || error.message}`;
                        uploadStatusEl.className = 'text-sm mt-2 text-red-400';
                        uploadButtonEl.disabled = false;
                        fileInputEl.disabled = false;
                        uploadLoadingEl.classList.add('hidden');
                    },
                    async () => {
                        const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                        const fileData = {
                            name: file.name, type: file.type, size: file.size,
                            uploadDate: Timestamp.now(), userId: currentUserId,
                            storagePath: storagePath, downloadURL: downloadURL
                        };
                        const filesCollectionPath = `artifacts/${hostAppId}/users/${currentUserId}/files`;
                        await addDoc(collection(db, filesCollectionPath), fileData);
                        uploadStatusEl.textContent = 'File uploaded successfully!';
                        uploadStatusEl.className = 'text-sm mt-2 text-green-400';
                        fileInputEl.value = '';
                        uploadButtonEl.disabled = false;
                        fileInputEl.disabled = false;
                        uploadLoadingEl.classList.add('hidden');
                    }
                );
            } catch (error) {
                console.error("Error initiating upload or saving metadata:", error);
                uploadStatusEl.textContent = `Error: ${error.message}`;
                uploadStatusEl.className = 'text-sm mt-2 text-red-400';
                uploadButtonEl.disabled = false;
                fileInputEl.disabled = false;
                uploadLoadingEl.classList.add('hidden');
            }
        });

        function fetchAndDisplayFiles() {
            if (!db || !currentUserId) {
                console.log("Firestore not ready or user not logged in for fetching files.");
                fileListEl.innerHTML = '<p class="text-yellow-400">Cannot load files: connection issue or not logged in.</p>';
                return;
            }
            filesLoadingEl.classList.remove('hidden');
            noFilesMessageEl.classList.add('hidden');
            const filesCollectionPath = `artifacts/${hostAppId}/users/${currentUserId}/files`;
            const q = query(collection(db, filesCollectionPath));
            if (unsubscribeFiles) unsubscribeFiles();
            unsubscribeFiles = onSnapshot(q, (querySnapshot) => {
                filesLoadingEl.classList.add('hidden');
                if (querySnapshot.empty) {
                    fileListEl.innerHTML = '';
                    noFilesMessageEl.classList.remove('hidden');
                } else {
                    noFilesMessageEl.classList.add('hidden');
                    fileListEl.innerHTML = '';
                    querySnapshot.forEach((docSnapshot) => {
                        renderFileItem(docSnapshot.id, docSnapshot.data());
                    });
                }
            }, (error) => {
                console.error("Error fetching files:", error.code, error.message, error);
                filesLoadingEl.classList.add('hidden');
                fileListEl.innerHTML = `<p class="text-red-400">Error loading files: ${error.message}</p>`;
                noFilesMessageEl.classList.add('hidden');
            });
        }

        function renderFileItem(fileId, fileData) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'file-item';
            itemDiv.setAttribute('data-id', fileId);
            const nameSpan = document.createElement('span');
            nameSpan.textContent = fileData.name;
            nameSpan.title = `${fileData.name} (${(fileData.size / 1024).toFixed(2)} KB) - Uploaded: ${fileData.uploadDate.toDate().toLocaleDateString()}`;
            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'flex space-x-2';
            const viewButton = document.createElement('a');
            viewButton.href = fileData.downloadURL;
            viewButton.textContent = 'View';
            viewButton.target = '_blank';
            viewButton.className = 'btn text-xs py-1 px-2 bg-green-600 hover:bg-green-700';
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'btn btn-danger text-xs py-1 px-2';
            deleteButton.onclick = () => openConfirmationModal('Delete File', `Are you sure you want to delete "${fileData.name}"? This action cannot be undone.`, () => deleteFile(fileId, fileData.storagePath, fileData.name));
            actionsDiv.appendChild(viewButton);
            actionsDiv.appendChild(deleteButton);
            itemDiv.appendChild(nameSpan);
            itemDiv.appendChild(actionsDiv);
            fileListEl.appendChild(itemDiv);
        }

        async function deleteFile(fileId, storagePath, fileName) {
            if (!db || !storage || !currentUserId) {
                console.error("Cannot delete: Services not ready or not logged in.");
                const statusEl = document.createElement('p');
                statusEl.textContent = "Error: Could not delete file. Services unavailable.";
                statusEl.className = "text-red-400 text-sm";
                fileListEl.prepend(statusEl);
                setTimeout(() => statusEl.remove(), 5000);
                return;
            }
            console.log(`Attempting to delete file: ID=${fileId}, Path=${storagePath}`);
            const fileStorageRef = ref(storage, storagePath);
            try {
                await deleteObject(fileStorageRef);
                console.log(`File deleted from Storage: ${storagePath}`);
                const fileDocRef = doc(db, `artifacts/${hostAppId}/users/${currentUserId}/files`, fileId);
                await deleteDoc(fileDocRef);
                console.log(`File metadata deleted from Firestore: ${fileId}`);
                const successMsg = document.createElement('p');
                successMsg.textContent = `"${fileName}" deleted successfully.`;
                successMsg.className = "text-green-400 text-sm p-2 bg-gray-700 rounded-md";
                fileManagementSectionEl.insertBefore(successMsg, fileManagementSectionEl.children[2]);
                setTimeout(() => successMsg.remove(), 3000);
            } catch (error) {
                console.error("Error deleting file:", error.code, error.message, error);
                const errorMsg = document.createElement('p');
                errorMsg.textContent = `Error deleting "${fileName}": ${error.code || error.message}`;
                errorMsg.className = "text-red-400 text-sm p-2 bg-gray-700 rounded-md";
                fileManagementSectionEl.insertBefore(errorMsg, fileManagementSectionEl.children[2]);
                setTimeout(() => errorMsg.remove(), 5000);
            }
        }
    </script>
</body>
</html>

